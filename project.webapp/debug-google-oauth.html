<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth Debug Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #dee2e6;
        }
        .status-card.success { border-left-color: #28a745; background-color: #d4edda; }
        .status-card.error { border-left-color: #dc3545; background-color: #f8d7da; }
        .status-card.warning { border-left-color: #ffc107; background-color: #fff3cd; }
        .status-card.info { border-left-color: #17a2b8; background-color: #d1ecf1; }
        
        .status-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .status-value {
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            justify-content: center;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        button.danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #4a5568;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #4a5568;
        }
        .log-timestamp {
            color: #a0aec0;
            margin-right: 10px;
        }
        .log-success { color: #68d391; }
        .log-error { color: #fc8181; }
        .log-warning { color: #f6e05e; }
        .log-info { color: #63b3ed; }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .test-result {
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
        }
        .test-result.success { background: #d4edda; border-color: #c3e6cb; }
        .test-result.error { background: #f8d7da; border-color: #f5c6cb; }
        .test-result.warning { background: #fff3cd; border-color: #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Google OAuth Debug Tool</h1>
            <p>Comprehensive debugging for Google OAuth authentication issues</p>
        </div>
        
        <div class="status-grid">
            <div class="status-card" id="env-status">
                <div class="status-title">Environment Variables</div>
                <div class="status-value" id="env-value">Checking...</div>
            </div>
            <div class="status-card" id="google-status">
                <div class="status-title">Google Services</div>
                <div class="status-value" id="google-value">Not loaded</div>
            </div>
            <div class="status-card" id="oauth-status">
                <div class="status-title">OAuth Configuration</div>
                <div class="status-value" id="oauth-value">Not tested</div>
            </div>
            <div class="status-card" id="backend-status">
                <div class="status-title">Backend Connection</div>
                <div class="status-value" id="backend-value">Not tested</div>
            </div>
        </div>
        
        <div class="button-group">
            <button onclick="runFullDiagnostic()">üîç Run Full Diagnostic</button>
            <button onclick="testEnvironmentVariables()">üìã Test Environment</button>
            <button onclick="testGoogleServices()">üåê Test Google Services</button>
            <button onclick="testOAuthFlow()">üîê Test OAuth Flow</button>
            <button onclick="testBackendConnection()">üîå Test Backend</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        
        <div class="test-results" id="test-results"></div>
        
        <div class="log-container" id="log-container"></div>
    </div>

    <script>
        let logContainer;
        let testResults;
        let progressFill;
        
        function log(message, type = 'info') {
            if (!logContainer) logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollTop + 1000;
        }
        
        function clearLog() {
            if (logContainer) logContainer.innerHTML = '';
            if (testResults) testResults.innerHTML = '';
            updateProgress(0);
        }
        
        function updateProgress(percentage) {
            if (!progressFill) progressFill = document.getElementById('progress-fill');
            progressFill.style.width = `${percentage}%`;
        }
        
        function updateStatus(cardId, title, value, type = 'info') {
            const card = document.getElementById(cardId);
            const valueElement = document.getElementById(cardId.replace('-status', '-value'));
            
            card.className = `status-card ${type}`;
            if (valueElement) valueElement.textContent = value;
        }
        
        function addTestResult(title, message, type = 'info') {
            if (!testResults) testResults = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `<strong>${title}</strong><br>${message}`;
            testResults.appendChild(resultDiv);
        }
        
        async function testEnvironmentVariables() {
            log('üîç Testing environment variables...', 'info');
            updateProgress(10);
            
            try {
                const apiUrl = import.meta?.env?.VITE_REACT_APP_API_URL;
                const googleClientId = import.meta?.env?.VITE_REACT_APP_GOOGLE_CLIENT_ID;
                
                log(`API URL: ${apiUrl || '‚ùå Not set'}`, apiUrl ? 'success' : 'error');
                log(`Google Client ID: ${googleClientId || '‚ùå Not set'}`, googleClientId ? 'success' : 'error');
                
                if (googleClientId && apiUrl) {
                    updateStatus('env-status', 'Environment Variables', '‚úÖ All Required Variables Set', 'success');
                    addTestResult('Environment Variables', 'All required variables are properly configured', 'success');
                    log('‚úÖ Environment variables are properly configured', 'success');
                } else {
                    updateStatus('env-status', 'Environment Variables', '‚ùå Missing Required Variables', 'error');
                    addTestResult('Environment Variables', 'Missing required environment variables', 'error');
                    log('‚ùå Please set VITE_REACT_APP_GOOGLE_CLIENT_ID and VITE_REACT_APP_API_URL in your .env file', 'error');
                }
                
                updateProgress(20);
                return !!(googleClientId && apiUrl);
            } catch (error) {
                log(`‚ùå Error testing environment variables: ${error.message}`, 'error');
                updateStatus('env-status', 'Environment Variables', '‚ùå Error Testing', 'error');
                updateProgress(20);
                return false;
            }
        }
        
        async function testGoogleServices() {
            log('üîç Testing Google Identity Services...', 'info');
            updateProgress(30);
            
            try {
                if (window.google) {
                    log('‚úÖ Google services already loaded', 'success');
                    updateStatus('google-status', 'Google Services', '‚úÖ Services Loaded', 'success');
                    addTestResult('Google Services', 'Google Identity Services are loaded and ready', 'success');
                    updateProgress(40);
                    return true;
                }
                
                log('üì• Loading Google Identity Services...', 'info');
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.async = true;
                script.defer = true;
                
                return new Promise((resolve) => {
                    script.onload = () => {
                        log('‚úÖ Google Identity Services loaded successfully', 'success');
                        updateStatus('google-status', 'Google Services', '‚úÖ Services Loaded', 'success');
                        addTestResult('Google Services', 'Google Identity Services loaded successfully', 'success');
                        updateProgress(40);
                        resolve(true);
                    };
                    
                    script.onerror = () => {
                        log('‚ùå Failed to load Google Identity Services', 'error');
                        updateStatus('google-status', 'Google Services', '‚ùå Load Failed', 'error');
                        addTestResult('Google Services', 'Failed to load Google Identity Services', 'error');
                        updateProgress(40);
                        resolve(false);
                    };
                    
                    document.head.appendChild(script);
                });
            } catch (error) {
                log(`‚ùå Error testing Google services: ${error.message}`, 'error');
                updateStatus('google-status', 'Google Services', '‚ùå Error Testing', 'error');
                updateProgress(40);
                return false;
            }
        }
        
        async function testBackendConnection() {
            log('üîç Testing backend connection...', 'info');
            updateProgress(50);
            
            try {
                const apiUrl = import.meta?.env?.VITE_REACT_APP_API_URL;
                if (!apiUrl) {
                    log('‚ùå Cannot test backend: API URL not set', 'error');
                    updateStatus('backend-status', 'Backend Connection', '‚ùå No API URL', 'error');
                    updateProgress(60);
                    return false;
                }
                
                log(`üåê Testing connection to: ${apiUrl}`, 'info');
                const response = await fetch(`${apiUrl}/auth/google-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true })
                });
                
                if (response.status === 400) {
                    // This is expected - we sent invalid data
                    log('‚úÖ Backend is reachable (400 response expected for test data)', 'success');
                    updateStatus('backend-status', 'Backend Connection', '‚úÖ Backend Reachable', 'success');
                    addTestResult('Backend Connection', 'Backend server is reachable and responding', 'success');
                } else {
                    log(`‚ö†Ô∏è Backend responded with unexpected status: ${response.status}`, 'warning');
                    updateStatus('backend-status', 'Backend Connection', '‚ö†Ô∏è Unexpected Response', 'warning');
                    addTestResult('Backend Connection', `Backend responded with status: ${response.status}`, 'warning');
                }
                
                updateProgress(60);
                return true;
            } catch (error) {
                log(`‚ùå Backend connection failed: ${error.message}`, 'error');
                updateStatus('backend-status', 'Backend Connection', '‚ùå Connection Failed', 'error');
                addTestResult('Backend Connection', `Connection failed: ${error.message}`, 'error');
                updateProgress(60);
                return false;
            }
        }
        
        async function testOAuthFlow() {
            log('üîç Testing OAuth flow configuration...', 'info');
            updateProgress(70);
            
            try {
                const googleClientId = import.meta?.env?.VITE_REACT_APP_GOOGLE_CLIENT_ID;
                
                if (!googleClientId) {
                    log('‚ùå Cannot test OAuth flow: Google Client ID is missing', 'error');
                    updateStatus('oauth-status', 'OAuth Configuration', '‚ùå Missing Client ID', 'error');
                    updateProgress(80);
                    return false;
                }
                
                if (!window.google) {
                    log('‚ùå Cannot test OAuth flow: Google services not loaded', 'warning');
                    updateStatus('oauth-status', 'OAuth Configuration', '‚ö†Ô∏è Services Not Loaded', 'warning');
                    updateProgress(80);
                    return false;
                }
                
                log('‚úÖ Testing OAuth client initialization...', 'info');
                
                // Test OAuth client initialization
                const client = window.google.accounts.oauth2.initTokenClient({
                    client_id: googleClientId,
                    scope: 'openid profile email',
                    redirect_uri: window.location.origin,
                    prompt: 'select_account',
                    callback: (response) => {
                        if (response.error) {
                            log(`‚ùå OAuth error: ${response.error}`, 'error');
                            updateStatus('oauth-status', 'OAuth Configuration', `‚ùå Error: ${response.error}`, 'error');
                            addTestResult('OAuth Flow', `OAuth error: ${response.error}`, 'error');
                        } else {
                            log('‚úÖ OAuth flow completed successfully!', 'success');
                            log(`Access token received: ${response.access_token ? 'Yes' : 'No'}`, 'success');
                            updateStatus('oauth-status', 'OAuth Configuration', '‚úÖ Flow Successful', 'success');
                            addTestResult('OAuth Flow', 'OAuth flow completed successfully', 'success');
                        }
                        updateProgress(100);
                    }
                });
                
                log('‚úÖ OAuth client initialized successfully', 'success');
                log('üîÑ Requesting access token...', 'info');
                
                // Request access token (this will open the OAuth popup)
                client.requestAccessToken();
                
                updateStatus('oauth-status', 'OAuth Configuration', 'üîÑ Testing Flow...', 'info');
                addTestResult('OAuth Flow', 'OAuth flow test initiated - check popup', 'info');
                
                return true;
                
            } catch (error) {
                log(`‚ùå Error testing OAuth flow: ${error.message}`, 'error');
                updateStatus('oauth-status', 'OAuth Configuration', '‚ùå Error Testing', 'error');
                addTestResult('OAuth Flow', `Test failed: ${error.message}`, 'error');
                updateProgress(80);
                return false;
            }
        }
        
        async function runFullDiagnostic() {
            log('üöÄ Starting full diagnostic...', 'info');
            clearLog();
            updateProgress(0);
            
            const results = {
                environment: await testEnvironmentVariables(),
                google: await testGoogleServices(),
                backend: await testBackendConnection(),
                oauth: false // Will be set by OAuth callback
            };
            
            log('üìä Diagnostic Summary:', 'info');
            log(`Environment Variables: ${results.environment ? '‚úÖ' : '‚ùå'}`, results.environment ? 'success' : 'error');
            log(`Google Services: ${results.google ? '‚úÖ' : '‚ùå'}`, results.google ? 'success' : 'error');
            log(`Backend Connection: ${results.backend ? '‚úÖ' : '‚ùå'}`, results.backend ? 'success' : 'error');
            
            if (results.environment && results.google && results.backend) {
                log('üîÑ Testing OAuth flow...', 'info');
                await testOAuthFlow();
            } else {
                log('‚ö†Ô∏è Skipping OAuth test due to previous failures', 'warning');
                updateProgress(100);
            }
        }
        
        // Auto-run environment test on page load
        window.addEventListener('load', () => {
            log('üöÄ Google OAuth Debug Tool Loaded', 'success');
            setTimeout(() => {
                testEnvironmentVariables();
            }, 500);
        });
    </script>
</body>
</html>
